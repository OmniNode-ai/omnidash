# SPDX-FileCopyrightText: 2025 OmniNode.ai Inc.
# SPDX-License-Identifier: MIT
name: Test

on:
  push:
    branches: [main, feature/**]
  pull_request:
    branches: [main]
  merge_group:

jobs:
  # Architectural invariant: omnidash must never query upstream databases directly.
  # All intelligence data must flow through Kafka into omnidash_analytics.
  # This job runs with no dependencies (pure grep) for a fast ~10s signal.
  arch-guard:
    name: Arch Guard (no upstream DB access)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: No omninode_bridge references
        run: |
          # Scan all TypeScript/TSX/JSON source files.
          # Excludes: node_modules, dist, the guard test file itself, package-lock.json.
          VIOLATIONS=$(grep -rn "omninode_bridge" \
            --include="*.ts" --include="*.tsx" --include="*.json" \
            --exclude="no-omninode-bridge-refs.test.ts" \
            --exclude="package-lock.json" \
            --exclude-dir=node_modules \
            --exclude-dir=dist \
            --exclude-dir=.git \
            --exclude-dir=coverage \
            . || true)
          if [ -n "$VIOLATIONS" ]; then
            echo "::error::Architectural violation: omnidash must not reference omninode_bridge directly."
            echo "All upstream data must flow through Kafka -> omnidash_analytics."
            echo ""
            echo "Violations found:"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "OK: No omninode_bridge references"

      - name: No direct upstream PostgreSQL port (5436)
        run: |
          # Port 5436 is the external port for the upstream omninode_bridge PostgreSQL instance.
          # omnidash should never open a connection to it directly.
          VIOLATIONS=$(grep -rn ":5436" \
            --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules \
            --exclude-dir=dist \
            --exclude-dir=.git \
            --exclude-dir=coverage \
            . || true)
          if [ -n "$VIOLATIONS" ]; then
            echo "::error::Architectural violation: direct connection to upstream PostgreSQL port 5436 detected."
            echo "omnidash connects only to omnidash_analytics via OMNIDASH_ANALYTICS_DB_URL."
            echo ""
            echo "Violations found:"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "OK: No hardcoded :5436 upstream DB port"

      - name: No deprecated omniarchon references
        run: |
          VIOLATIONS=$(grep -rn "omniarchon" \
            --include="*.ts" --include="*.tsx" --include="*.json" \
            --exclude="no-omninode-bridge-refs.test.ts" \
            --exclude="package-lock.json" \
            --exclude-dir=node_modules \
            --exclude-dir=dist \
            --exclude-dir=.git \
            --exclude-dir=coverage \
            . || true)
          if [ -n "$VIOLATIONS" ]; then
            echo "::error::Architectural violation: omniarchon is a deprecated service and must not be referenced."
            echo ""
            echo "Violations found:"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "OK: No omniarchon references"

  test:
    name: Run Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [24.x, 22.x, 20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type checking
        run: npm run check

      - name: Run unit tests
        run: npm run test:ci
        timeout-minutes: 10
        env:
          CI: true
          FORCE_COLOR: 0

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ matrix.node-version }}
          path: coverage/
          retention-days: 7

      - name: Build
        run: npm run build

  # Aggregator job: branch protection requires this single check name
  # instead of individual matrix entries (which change when versions update).
  tests-gate:
    name: CI Tests Gate
    runs-on: ubuntu-latest
    needs: [test, arch-guard]
    if: always()
    steps:
      - name: Check test results
        env:
          TEST_RESULT: ${{ needs.test.result }}
          ARCH_RESULT: ${{ needs.arch-guard.result }}
        run: |
          FAILED=0
          if [ "$TEST_RESULT" != "success" ]; then
            echo "::error::One or more test matrix jobs failed or were cancelled"
            echo "Test matrix result: $TEST_RESULT"
            FAILED=1
          fi
          if [ "$ARCH_RESULT" != "success" ]; then
            echo "::error::Architectural guard failed -- omnidash must not access upstream databases directly"
            echo "Arch guard result: $ARCH_RESULT"
            FAILED=1
          fi
          if [ "$FAILED" = "1" ]; then exit 1; fi
          echo "All checks passed (tests: $TEST_RESULT, arch-guard: $ARCH_RESULT)"
